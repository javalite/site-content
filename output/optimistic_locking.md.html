<ol class=breadcrumb>
   <li>
<a href=/>JavaLite</a>
</li>
   <li>
<a href=/activejdbc>ActiveJDBC</a>
</li>
   <li class=active>
Optimistic locking
</li>
</ol>
<div class=page-header>
   <h1>
Optimistic locking <small></small>
</h1>
</div>



<p>The idea of optimistic locking is described here: <a href="http://en.wikipedia.org/wiki/Optimistic_concurrency_control">Optimistic concurrency control</a></p>
<p>ActiveJDBC provides support for optimistic concurrency via a simple convention: A database table needs to provide a column named <code>record_version</code> with a type that is capable to store non-decimal types, such as LONG for MySQL, NUMBER for Oracle, etc.</p>
<h2 id="creation-of-a-new-record">Creation of a new record</h2>
<p>Let's say you have a model:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Profile <span class="kw">extends</span> Model{}</code></pre>
<p>which backs a table <code>PROFILES</code>:</p>
<p>+----+--------------+------------------+ | id | profile_type | record_version | +====+==============+==================+</p>
<p>When you create a new record:</p>
<pre class="sourceCode java"><code class="sourceCode java">Profile.<span class="fu">createIt</span>(<span class="st">&quot;profile_type&quot;</span>, <span class="st">&quot;home&quot;</span>);</code></pre>
<p>a new record is inserted into the table:</p>
<table>
<col width="6%" />
<col width="20%" />
<col width="26%" />
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">profile_type</th>
<th align="left">record_version</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>1</p></td>
<td align="left"><p>home</p></td>
<td align="left"><p>1</p></td>
</tr>
</tbody>
</table>
<p>The value 1 in the <code>record_version</code> column signifies that this record has not been updated yet.</p>
<h2 id="updating-a-record">Updating a record</h2>
<p>When a record is updated, the value of column <code>record_version</code> is incremented by one:</p>
<pre class="sourceCode java"><code class="sourceCode java">Profile p = Profile.<span class="fu">findById</span>(<span class="dv">1</span>);
p.<span class="fu">set</span>(<span class="st">&quot;profile_type&quot;</span>, <span class="st">&quot;work&quot;</span>);
p.<span class="fu">saveIt</span>();</code></pre>
<p>The resulting record in the database will look like this:</p>
<table>
<col width="6%" />
<col width="20%" />
<col width="26%" />
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">profile_type</th>
<th align="left">record_version</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>1</p></td>
<td align="left"><p>work</p></td>
<td align="left"><p>2</p></td>
</tr>
</tbody>
</table>
<p>As you can see, ActiveJDBC tracks versions of the same record.</p>
<h2 id="when-collisions-happen">When collisions happen</h2>
<p>Sometimes you might have code that reads the same record from a table in order to be updated. In those cases, the first update succeeds, but the second does not. Let's examine this situation:</p>
<pre class="sourceCode java"><code class="sourceCode java">Profile p1 = Profile.<span class="fu">findById</span>(<span class="dv">1</span>);
Profile p2 = Profile.<span class="fu">findById</span>(<span class="dv">1</span>);

p1.<span class="fu">set</span>(<span class="st">&quot;profile_type&quot;</span>, <span class="st">&quot;hotel&quot;</span>);
p1.<span class="fu">saveIt</span>();

p2.<span class="fu">set</span>(<span class="st">&quot;profile_type&quot;</span>, <span class="st">&quot;vacation&quot;</span>);
p2.<span class="fu">saveIt</span>(); <span class="co">//&lt;&lt;&lt;========= This will throw a StaleModelException</span></code></pre>
<p>In the code snippet above, at lines 1 and 2, the same record is loaded into models. Then, at line 5, the first one is updated. This will increment the version of the record to 3, and make the model p2 stale. Henceforth, when you try to save the model p2, you will get an exception. The content of a record in the table at this point will be:</p>
<table>
<col width="6%" />
<col width="20%" />
<col width="26%" />
<thead>
<tr class="header">
<th align="left">id</th>
<th align="left">profile_type</th>
<th align="left">record_version</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>1</p></td>
<td align="left"><p>hotel</p></td>
<td align="left"><p>3</p></td>
</tr>
</tbody>
</table>
<p>Here is the output of the StaleModelException:</p>
<pre class="prettyprint"><code>org.javalite.activejdbc.StaleModelException: Failed to update record for model &#39;class com.acme.Profile&#39;, with id = 1 and record_version = 2. Either this record does not exist anymore, or has been updated to have another record_version.</code></pre>
<p>This message provides enough detail to understand what happened.</p>
<h2 id="override-default-version-column">Override default version column</h2>
<p>By default a version column is called <code>version_record</code>. In cases where there is already existing schema or you need compatibility with other systems, you can override the name with annotation:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">@VersionColumn</span>(<span class="st">&quot;lock_version&quot;</span>)
<span class="kw">public</span> <span class="kw">class</span> Item <span class="kw">extends</span> Model { <span class="kw">... </span>}</code></pre>
<p>The version numbers will be stored in <code>lock_version</code> column, while everything else will work as expected.</p>
<h2 id="how-optimistic-locking-is-engaged">How optimistic locking is engaged</h2>
<p>The rule is very simple, ActiveJDBC finds <code>record_version</code> column and dynamically configures itself to handle optimistic locking. This means that if this column is present, optimistic locking will be engaged. If the record is not present, optimistic locking will not be engaged. If you did not have this column, and later added it, you need to restart the system because ActiveJDBC scans database schema at the start.</p>
<p>Conversely, if you want to turn it off, drop column <code>record_version</code> and restart the system.</p>
<h2 id="advice">Advice</h2>
<p>Application developers using optimistic locking should be aware of exception <a href="http://javalite.github.io/activejdbc/org/javalite/activejdbc/StaleModelException.html">StaleModelException</a> (even though it is a RuntimeException) and build controls into their code to intercept and handle it appropriately.</p>
